{% extends 'base.html' %}

{% block content %}

{% load cart %}
{% load custom_filter %}

<!-- body -->
<div class="container-fluid mt-3">
    <div class="row">

        <!-- filter and sort -->
        <div class="col-lg-3 mx-auto">
            <div class="list-group">
                <a href="/" class="list-group-item list-group-item-action btn btn-outline-success">Products</a>
                {% for category in categories %}
                <a href="/?category={{category.id}}" class="list-group-item list-group-item-action btn btn-outline-success">
                    {{category.name}}
                </a>
                {% endfor %}
            </div>
            <div class="list-group mt-3">
                <label for="sort-price" class="list-group-item">Sort by Price:</label>
                <select id="sort-price" class="form-control">
                    <option value="default">Default</option>
                    <option value="low-to-high">Low to High</option>
                    <option value="high-to-low">High to Low</option>
                </select>
            </div>
            <div class="list-group mt-3">
                <label for="price-range" class="list-group-item">Filter by Price:</label>
                <input type="range" class="form-control-range" id="price-range" min="0" max="100000" step="10">
                <p id="price-range-value" class="text-center">0 - 100000</p>
            </div>
        </div>

        <!-- search form -->
        <div class="col-lg-9 mx-auto">
            <form class="form-inline my-2 my-lg-0 mx-auto" id="search-form">
                <input class="form-control mr-sm-2" type="search" id="search-query" placeholder="Search for products, brands and more" aria-label="Search">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
            </form>
        </div>

        <!-- all products -->
        <div id='products' class="col-lg-9 mx-auto mt-3">
            <div class="row mx-auto" id="products-list">
                {% for product in products %}
                <div class="card mx-auto mb-3 product-card" id="{{product.id}}" style="width: 18rem;" data-name="{{ product.name }}" data-category="{{ product.category.name }}" data-price="{{ product.price }}">
                    <img class="card-img-top" src="{{product.image.url}}" alt="Card image cap">
                    <div class="card-body">
                        <p class="card-title">{{product.name}}</p>
                        <p class="card-text"><b>{{product.price|currency}}</b></p>
                    </div>
                    <div class="card-footer p-0 no-gutters">
                        {% if product|is_in_cart:request.session.cart %}
                        <div class="row no-gutters">
                            <form action="/#{{product.id}}" class="col-2 " method="post">
                                {% csrf_token %}
                                <input hidden type="text" name='product' value='{{product.id}}'>
                                <input hidden type="text" name='remove' value='True'>
                                <input type="submit" value=" - " class="btn btn-block btn-success border-right">
                            </form>
                            <div class="text-center col btn btn-success">{{product|cart_quantity:request.session.cart}} in Cart</div>
                            <form action="/#{{product.id}}" class="col-2 " method="post">
                                {% csrf_token %}
                                <input hidden type="text" name='product' value='{{product.id}}'>
                                <input type="submit" value=" + " class="btn btn-block btn-success border-left">
                            </form>
                        </div>
                        {% else %}
                        <form action="/#{{product.id}}" method="POST" class="btn-block">
                            {% csrf_token %}
                            <input hidden type="text" name='product' value='{{product.id}}'>
                            <input type="submit" class="float-right btn btn-success form-control" value="Add To Cart">
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7H2IbX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script>
    document.getElementById('search-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const query = document.getElementById('search-query').value.toLowerCase();
        const products = document.querySelectorAll('.product-card');
        
        products.forEach(product => {
            const name = product.getAttribute('data-name').toLowerCase();
            const category = product.getAttribute('data-category').toLowerCase();
            if (name.includes(query) || category.includes(query)) {
                product.style.display = 'block';
            } else {
                product.style.display = 'none';
            }
        });
    });

    document.getElementById('sort-price').addEventListener('change', function () {
        const sortValue = this.value;
        const productsContainer = document.getElementById('products-list');
        const products = Array.from(productsContainer.getElementsByClassName('product-card'));
        
        if (sortValue === 'low-to-high') {
            products.sort((a, b) => parseFloat(a.getAttribute('data-price')) - parseFloat(b.getAttribute('data-price')));
        } else if (sortValue === 'high-to-low') {
            products.sort((a, b) => parseFloat(b.getAttribute('data-price')) - parseFloat(a.getAttribute('data-price')));
        } else {
            // Default sorting: by product id or any other default logic you have
            products.sort((a, b) => parseInt(a.id) - parseInt(b.id));
        }

        products.forEach(product => {
            productsContainer.appendChild(product);
        });
    });

    document.getElementById('price-range').addEventListener('input', function () {
        const maxPrice = this.value;
        document.getElementById('price-range-value').innerText = `0 - ${maxPrice}`;
        const products = document.querySelectorAll('.product-card');
        
        products.forEach(product => {
            const price = parseFloat(product.getAttribute('data-price'));
            if (price <= maxPrice) {
                product.style.display = 'block';
            } else {
                product.style.display = 'none';
            }
        });
    });
</script>

{% endblock %}
